#!/bin/sh

set -e


if [[ "$(uname)" == "Darwin" ]]; then
  echo "This script is only supported in Heroku dynos"
  exit 1
fi

install_java () {
  # Initial cleanup
  rm -rf /tmp/jvm.tgz /tmp/jre || true

  # Create required dirs if they do not exist
  mkdir -p /tmp/jre /app

  # Fetch and Extract Heroku java installer
  wget https://buildpack-registry.s3.us-east-1.amazonaws.com/buildpacks/heroku/jvm.tgz -O /tmp/jvm.tgz
  tar -zxvf /tmp/jvm.tgz -C /tmp/jre/

  # Default to Java 21 if file does not exist
  if [ ! -f /app/system.properties ]; then
      echo "java.runtime.version = 21" >> /app/system.properties
  fi

  # Install Java to /app including .profile.d shell scripts which set JAVA_HOME etc
  source /tmp/jre/bin/util; source /tmp/jre/bin/java; source /tmp/jre/opt/jdbc.sh
  install_dir=/app; cache_dir=/tmp; install_java_with_overlay "${install_dir}" "${cache_dir}"
}

install_java

