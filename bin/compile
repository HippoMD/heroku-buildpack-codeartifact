#!/bin/bash

set -e


if [[ "$(uname)" == "Darwin" ]]; then
  echo "This script is only supported in Heroku dynos"
  exit 1
fi


# BUILD_DIR and CACHE_DIR are provided by Heroku's build env
echo "BUILD_DIR is: $BUILD_DIR"

install_java () {
  # Initial cleanup
  rm -rf /tmp/jvm.tgz /tmp/jre || true

  # Create required dirs if they do not exist
  mkdir -p /tmp/jre

  # Fetch and Extract Heroku java installer
  wget https://buildpack-registry.s3.us-east-1.amazonaws.com/buildpacks/heroku/jvm.tgz -O /tmp/jvm.tgz
  tar -zxvf /tmp/jvm.tgz -C /tmp/jre/

  # Default to Java 21 if file does not exist
  # $REPO_ROOT/$ is mounted read-only, we should add this file to the repo
  # if [ ! -f ${BUILD_DIR}/system.properties ]; then
  #    echo "java.runtime.version = 21" >> ${BUILD_DIR}/system.properties
  # fi

  # debug
  find /tmp/jre
  find /tmp -type f -name util
  find /tmp -type f -name java
  find /tmp -type f -name jdbc.sh

  # Install Java to ${BUILD_DIR}/ including .profile.d shell scripts which set JAVA_HOME etc
  source /tmp/jre/bin/util
  source /tmp/jre/bin/java
  source /tmp/jre/opt/jdbc.sh

  install_java_with_overlay "${BUILD_DIR}" "${CACHE_DIR}"
}

install_java

echo "Listing ${BUILD_DIR}/"
ls -al ${BUILD_DIR}/
echo "Listing ${BUILD_DIR}//profile.d"
ls -al ${BUILD_DIR}/.profile.d

